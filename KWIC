#!/usr/bin/env perl
use lib '/home/wm/wm023/modules';
use Mojolicious::Lite;
use Mojo::Log;
use Mojo::JSON 'to_json';
use DBI;

my $dbh = DBI->connect("dbi:SQLite:dbname=db/KWIC.db");

my $log = Mojo::Log->new;

get '/' => sub {
    my $c = shift;
    $c->render( template => 'index' );
};

post '/KWIC' => sub {
    my $c      = shift;
	my $data = $c->param('input');
	my $output = join '<br />',`echo '$data' | ./SOParser | uniq`;
    $c->render( 
		template => 'KWIC', 
		output => $output,
	);
};

post '/insert' => sub {
	my $c = shift;
	my $data = $c->req->json;
	$log->debug("Received from client: ");
	$log->debug(to_json($data));


	# Echo data back to client
	$c->render(
		json => $data
	);
};

app->start;
__DATA__

@@ index.html.ep
% layout 'default';
% title 'Welcome';
<h1> KWIC </h1>
<form action="/KWIC" method="POST">
<textarea name="input" rows="20" cols="80"></textarea>
<br />
<input type="submit" value="Submit">
</form>

@@ KWIC.html.ep
% layout 'default';
% title 'Welcome';
<h3> Output: <br /><%== $output %> 

@@ layouts/default.html.ep
<!DOCTYPE html>
<html>
  <head><title><%= title %></title></head>
  <body><%= content %></body>
</html>
